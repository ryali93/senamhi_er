/*
 Template Name: Color Admin - Responsive Admin Dashboard Template build with Twitter Bootstrap 3.3.6
 Version: 3.0.0
 Author: Antero Matos Zabarburu
 */

var handleOpenLayerSetting = function (proyeccion, extent, presicionDecimal, wmsCurrent, layerCurrent, layerCurrentTitle, wmsMapaBase, keyBingMap, dominio) {

    var format = "image/png";
    var url = wmsCurrent;

    /*Inicio: proyeccion*/
    //proj4.defs(proyeccion, "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs");
    proj4.defs(proyeccion, "+proj=longlat +datum=WGS84 +no_defs");

    var projection = new ol.proj.Projection({
        code: proyeccion,
        units: 'degrees',
        axisOrientation: 'neu'
    });

    var view = new ol.View({
        projection: projection,
        center: [(extent[0] + extent[2]) / 2, (extent[1] + extent[3]) / 2],
        zoom: 6,
        minZoom: 6,
        maxZoom: 28
        //resolution: 39135.75848201024
    });
    /*Fin: proyeccion*/

    var controls = ol.control.defaults({rotate: false});
    var interactions = ol.interaction.defaults({
        altShiftDragRotate: false,
        pinchRotate: false,
        condition: ol.events.condition.mouseMove
    });

    /*Inicio: Mapa Base*/
    var layersMapaBase = [
        new ol.layer.Tile({
            title: 'Stamen Toner',
            type: 'base',
            combine: false,
            visible: false,
            source: new ol.source.Stamen({
                layer: 'toner'
            })
        }),
        new ol.layer.Group({
            title: 'Stamen Water color',
            type: 'base',
            combine: true,
            visible: false,
            layers: [
                new ol.layer.Tile({
                    visible: true,
                    source: new ol.source.Stamen({
                        layer: 'watercolor'
                    })
                }),
                new ol.layer.Tile({
                    visible: false,
                    source: new ol.source.Stamen({
                        layer: 'terrain-labels'
                    })
                })
            ]
        }),
        new ol.layer.Tile({
            title: 'OpenStreetMap',
            type: 'xyz',
            visible: true,
            source: new ol.source.OSM()
        }),
        new ol.layer.Tile({
            title: 'ArcGis',
            type: 'base',
            visible: false,
            source: new ol.source.XYZ({
                attributions: [new ol.Attribution({
                        html: 'Tiles Â© <a href="http://services.arcgisonline.com/ArcGIS/' +
                                'rest/services/World_Topo_Map/MapServer">ArcGIS</a>'
                    })],
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}'
            })
        }),
        new ol.layer.Group({
            title: 'Bing Maps Aerial',
            type: 'base',
            combine: true,
            visible: false,
            layers: [
                new ol.layer.Tile({
                    visible: true,
                    source: new ol.source.BingMaps({
                        key: keyBingMap,
                        imagerySet: 'Aerial'
                    })
                }),
                new ol.layer.Tile({
                    visible: false,
                    source: new ol.source.Stamen({
                        layer: 'terrain-labels'
                    })
                })
            ]
        }),
        new ol.layer.Group({
            title: 'Bing Maps Road',
            type: 'base',
            combine: true,
            visible: false,
            layers: [
                new ol.layer.Tile({
                    visible: true,
                    source: new ol.source.BingMaps({
                        key: keyBingMap,
                        imagerySet: 'Road'
                    })
                }),
                new ol.layer.Tile({
                    visible: false,
                    source: new ol.source.Stamen({
                        layer: 'terrain-labels'
                    })
                })
            ]
        }),
        new ol.layer.Group({
            title: 'Bing Maps AerialWithLabels',
            type: 'base',
            combine: true,
            visible: false,
            layers: [
                new ol.layer.Tile({
                    visible: true,
                    source: new ol.source.BingMaps({
                        key: keyBingMap,
                        imagerySet: 'AerialWithLabels'
                    })
                }),
                new ol.layer.Tile({
                    visible: false,
                    source: new ol.source.Stamen({
                        layer: 'terrain-labels'
                    })
                })
            ]
        }),
        new ol.layer.Tile({
            title: 'MapBox',
            type: 'base',
            combine: false,
            visible: false,
            source: new ol.source.TileJSON({
                url: 'https://api.tiles.mapbox.com/v3/mapbox.geography-class.json?secure',
                crossOrigin: ''
            })
        }),
        new ol.layer.Tile({
            title: "Natural Earth",
            type: 'base',
            combine: false,
            visible: false,
            source: new ol.source.XYZ(
                    {url: 'http://{a-d}.tiles.mapbox.com/v3/mapbox.natural-earth-hypso-bathy/{z}/{x}/{y}.png',
                        attributions: [new ol.Attribution({html: '&copy; <a href="https://www.mapbox.com/map-feedback/">Mapbox</a> '})]
                    })
        })
    ];
    /*Fin: Mapa Base*/

    /*Inicio: Cartografia Base*/
    var layersCartografiaBase = [
        new ol.layer.Group({
            //title: 'Mapa Base',
            type: 'base',
            combine: true,
            visible: true,
            layers: [
                new ol.layer.Tile({
                    title: 'Vias',
                    visible: false,
                    source: new ol.source.TileWMS({
                        url: dominio + '/geoserver/g_00_04/wms',
                        params: {'LAYERS': 'g_00_04:00_04_001_03_000_000_0000_00_00'},
                        serverType: 'geoserver'
                    })
                }),
                new ol.layer.Image({
                    title: 'Cuencas',
                    visible: false,
                    source: new ol.source.ImageWMS({
                        url: dominio + '/geoserver/g_00_06/wms',
                        params: {'LAYERS': 'g_00_06:00_06_001_03_000_000_0000_00_00'},
                        serverType: 'geoserver'
                    })
                }),
                new ol.layer.Tile({
                    title: 'Rios',
                    visible: false,
                    source: new ol.source.TileWMS({
                        url: dominio + '/geoserver/g_00_05/wms',
                        params: {'LAYERS': 'g_00_05:00_05_001_03_000_000_0000_00_00'},
                        serverType: 'geoserver'
                    })
                }),
                new ol.layer.Tile({
                    title: 'Distritos',
                    visible: false,
                    source: new ol.source.TileWMS({
                        url: dominio + '/geoserver/g_00_01/wms',
                        params: {'LAYERS': 'g_00_01:00_01_003_03_000_000_0000_00_00'},
                        serverType: 'geoserver'
                    })
                }),
                new ol.layer.Tile({
                    title: 'Provincias',
                    visible: false,
                    source: new ol.source.TileWMS({
                        url: dominio + '/geoserver/g_00_02/wms',
                        params: {'LAYERS': 'g_00_02:00_02_003_03_000_000_0000_00_00'},
                        serverType: 'geoserver'
                    })
                }),
                new ol.layer.Tile({
                    title: 'Departamentos',
                    visible: true,
                    source: new ol.source.TileWMS({
                        url: dominio + '/geoserver/g_00_02/wms',
                        params: {'LAYERS': 'g_00_02:00_02_002_03_000_000_0000_00_00'},
                        serverType: 'geoserver'
                    })
                }),
                new ol.layer.Image({
                    title: 'pnud',
                    visible: true,
                    source: new ol.source.ImageWMS({
                      ratio: 1,
                      url: 'http://localhost:8080/geoserver/pnud_ra/wms',
                      params: {"LAYERS": 'pnud_ra:ra_temp_anual'},
                      serverType: 'geoserver'
                   })   
                })
            ]
        })
    ];
    /*Fin: Cartografia Base*/

    /*Inicio: Cartografia Tematica*/
    var parser = new ol.format.WMSCapabilities();

    var current_wms = [
        new ol.layer.Tile({
            title: layerCurrentTitle,
            visible: true,
            source: new ol.source.TileWMS({
                url: wmsCurrent,
                params: {'LAYERS': layerCurrent},
                serverType: 'geoserver'
            })
        })
    ];
    /*Fin: Cartografia Tematica*/

    /*Inicio: Union de Capas o Layers*/
    if (layerCurrentTitle === 'g_00_02:00_02_002_03_000_000_0000_00_00') {
        layers = [
            new ol.layer.Group({'title': 'Mapa Base', layers: layersMapaBase}),
            new ol.layer.Group({title: 'CARTOGRAFIA BASE', layers: layersCartografiaBase})
        ];
    } else {
        layers = [
            new ol.layer.Group({'title': 'Mapa Base', layers: layersMapaBase}),
            //overlayGroupPP,
            new ol.layer.Group({title: "Cartograf\xeda Tem\xe1tica", layers: current_wms}),
            new ol.layer.Group({title: 'CARTOGRAFIA BASE', layers: layersCartografiaBase})
        ];
    }
    /*Fin: Union de Capas o Layers*/

    /*Inicio: Mapa*/
    var map = new ol.Map({
        target: document.getElementById('map'),
        renderer: 'canvas',
        layers: layers,
        view: view,
        controls: controls,
        interactions: interactions,

        loadTilesWhileAnimating: true,
        loadTilesWhileInteracting: true,

        controls: ol.control.defaults({
            attribution: false,
            attributionOptions: ({
                collapsible: false
            })
        }).extend([
            new ol.control.FullScreen(),
            new ol.control.LayerSwitcher(),
            new ol.control.ZoomSlider(),
            new ol.control.CanvasScaleLine()
        ])
    });
    /*Fin: Mapa*/

    /*Inicio: Controles*/
    //...i
    var dragdrop = new ol.interaction.DragAndDrop({formatConstructors: [ol.format.GPX, ol.format.KML, ol.format.GeoJSON]});
    map.addInteraction(dragdrop);

    dragdrop.on("addfeatures", function (a) {
        a = new ol.source.Vector({features: a.features, projection: a.projection});
        map.getLayers().push(new ol.layer.Vector({source: a}));
        map.getView().fitExtent(a.getExtent(), map.getSize())
    });
    //...f
    //...i
    var mouse_position = new ol.control.MousePosition({
        className: 'ol-mouse-position',
        coordinateFormat: ol.coordinate.createStringXY(presicionDecimal),
        projection: map.getView().getProjection()
    });
    map.addControl(mouse_position);
    //...f

    //...i
    var zoom_to_extent = new ol.control.ZoomToExtent({
        extent: extent});
    map.addControl(zoom_to_extent);

    var sidebar = new ol.control.Sidebar({ element: 'sidebar_ol', position: 'right' });
    map.addControl(sidebar);
    //...f

    //...i
    var popup = new ol.Overlay.Popup();
    popup.setOffset([0, 0]);
    map.addOverlay(popup);


    

    // var wmsLayer = new ol.layer.Image({
    //                 title: 'pnud',
    //                 visible: true,
    //                 source: new ol.source.ImageWMS({
    //                   ratio: 1,
    //                   url: 'http://localhost:8080/geoserver/pnud_ra/wms',
    //                   params: {"LAYERS": 'pnud_ra:ra_temp_anual'},
    //                   serverType: 'geoserver'
    //                })   
    //             })

    // var wmsSource = new ol.source.ImageWMS({
    //                   ratio: 1,
    //                   url: 'http://localhost:8080/geoserver/pnud_ra/wms',
    //                   params: {"LAYERS": 'pnud_ra:ra_temp_anual'},
    //                   serverType: 'geoserver'
    //                });

    var wmsSource = new ol.source.ImageWMS({
      url: 'http://localhost:8080/geoserver/pnud_ra/wms',
      params: {'LAYERS': 'pnud_ra:ra_temp_anual'},
      serverType: 'geoserver'
    });

    var wmsLayer = new ol.layer.Image({
      source: wmsSource,
    });

    // const wmsSource = new ImageWMS({
    //   url: 'https://ahocevar.com/geoserver/wms',
    //   params: {'LAYERS': 'ne:ne'},
    //   serverType: 'geoserver',
    //   crossOrigin: 'anonymous'
    // });

    // const wmsLayer = new ImageLayer({
    //   source: wmsSource
    // });

    // map.on('singleclick', function (evt) {
    //     document.getElementById('info').innerHTML = '';
    //     var viewResolution = (view.getResolution());
    //     var url = wmsSource.getGetFeatureInfoUrl(
    //         evt.coordinate, viewResolution, 'EPSG:3857',
    //         {'INFO_FORMAT': 'text/html'}
    //   )
    //   if (url) {
    //     console.log(url);
    //     fetch(url)
    //       .then(function (response) { return response.text(); })
    //       .then(function (html) {
    //         document.getElementById('info').innerHTML = html;
    //       });
    //   }
    // });

    map.on('singleclick', function (evt) {
      document.getElementById('info').innerHTML = '';
      var viewResolution = (view.getResolution());
      var url = wmsSource.getGetFeatureInfoUrl(
        evt.coordinate,
        viewResolution,
        'EPSG:3857',
        {'INFO_FORMAT': 'text/html'}
      );
      if (url) {
        console.log(url);
        fetch(url)
          .then(function (response) { return response.text(); })
          .then(function (html) {
            document.getElementById('info').innerHTML = html;
          });
      }
    });

    // map.on('singleclick', function(evt) {
    //     console.log(evt);
    //     document.getElementById('info').innerHTML = '';
    //     const viewResolution = (view.getResolution());
    //     const url = wmsSource.getFeatureInfoUrl(
    //         evt.coordinate, viewResolution, 'EPSG:3857',
    //         {'INFO_FORMAT': 'text/html'}
    //     );
    //     if (url) {
    //         fetch(url)
    //             .then((response) => response.text())
    //             .then((html) => {
    //         document.getElementById('info').innerHTML = html;
    //       });
    //   }
    // });









    //...f
    /*Fin: Controles*/

    /*Inicio: Show Mapa*/
    map.getView().fit(extent, map.getSize());
    /*Fin: Show Mapa*/

};


//...Funcion principal...
var MapOpenLayer = function (proyeccion, extent, presicionDecimal, wmsCurrent, layerCurrent, layerCurrentTitle, wmsMapaBase, keyBingMap, dominio) {
    return{
        init: function (proyeccion, extent, presicionDecimal, wmsCurrent, layerCurrent, layerCurrentTitle, wmsMapaBase, keyBingMap, dominio) {
            handleOpenLayerSetting(proyeccion, extent, presicionDecimal, wmsCurrent, layerCurrent, layerCurrentTitle, wmsMapaBase, keyBingMap, dominio);
        }
    };
}();

