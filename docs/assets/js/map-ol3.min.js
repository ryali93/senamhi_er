/*
 Template Name: Color Admin - Responsive Admin Dashboard Template build with Twitter Bootstrap 3.3.6
 Version: 3.0.0
 Author: Antero Matos Zabarburu
 */

var handleOpenLayerSetting = function (proyeccion, extent, presicionDecimal, wmsCurrent, layerCurrent, layerCurrentTitle, wmsMapaBase, keyBingMap, dominio) {

    var format = "image/png";
    var url = wmsCurrent;

    /*Inicio: proyeccion*/
    //proj4.defs(proyeccion, "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs");
    proj4.defs(proyeccion, "+proj=longlat +datum=WGS84 +no_defs");

    var projection = new ol.proj.Projection({
        code: proyeccion,
        units: 'degrees',
        axisOrientation: 'neu'
    });

    var view = new ol.View({
        projection: projection,
        center: [(extent[0] + extent[2]) / 2, (extent[1] + extent[3]) / 2],
        zoom: 6,
        minZoom: 6,
        maxZoom: 28
        //resolution: 39135.75848201024
    });
    /*Fin: proyeccion*/

    var controls = ol.control.defaults({rotate: false});
    var interactions = ol.interaction.defaults({
        altShiftDragRotate: false,
        pinchRotate: false,
        condition: ol.events.condition.mouseMove
    });

    /*Inicio: Mapa Base*/
    var layersMapaBase = [
        new ol.layer.Group({
            title: 'Stamen Water color',
            type: 'base',
            combine: true,
            visible: false,
            layers: [
                new ol.layer.Tile({
                    visible: true,
                    source: new ol.source.Stamen({
                        layer: 'watercolor'
                    })
                }),
                new ol.layer.Tile({
                    visible: false,
                    source: new ol.source.Stamen({
                        layer: 'terrain-labels'
                    })
                })
            ]
        }),
        new ol.layer.Tile({
            title: 'OpenStreetMap',
            type: 'xyz',
            visible: true,
            source: new ol.source.OSM()
        }),
        new ol.layer.Tile({
            title: 'ArcGis',
            type: 'base',
            visible: false,
            source: new ol.source.XYZ({
                attributions: [new ol.Attribution({
                        html: 'Tiles Â© <a href="http://services.arcgisonline.com/ArcGIS/' +
                                'rest/services/World_Topo_Map/MapServer">ArcGIS</a>'
                    })],
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}'
            })
        })
    ];
    /*Fin: Mapa Base*/

    /*Inicio: Cartografia Base*/
    var layersCartografiaBase = [
        new ol.layer.Group({
            //title: 'Mapa Base',
            type: 'base',
            combine: true,
            visible: true,
            layers: [
                new ol.layer.Image({
                    title: 'Quantiles',
                    visible: true,
                    source: new ol.source.ImageWMS({
                      ratio: 1,
                      url: 'http://localhost:8080/geoserver/senamhi_v1/wms',
                      params: {"LAYERS": 'senamhi_v1:q_pp'},
                      serverType: 'geoserver'
                   })   
                }),
                new ol.layer.Tile({
                    title: 'Regiones',
                    visible: true,
                    source: new ol.source.TileWMS({
                        url: 'http://localhost:8080/geoserver/senamhi_v1/wms',
                        params: {'LAYERS': 'senamhi_v1:gpo_regiones_pp_max'},
                        serverType: 'geoserver'
                    })
                })
            ]
        })
    ];
    /*Fin: Cartografia Base*/

    /*Inicio: Cartografia Tematica*/
    var parser = new ol.format.WMSCapabilities();

    var current_wms = [
        new ol.layer.Tile({
            title: layerCurrentTitle,
            visible: true,
            source: new ol.source.TileWMS({
                url: wmsCurrent,
                params: {'LAYERS': layerCurrent},
                serverType: 'geoserver'
            })
        })
    ];
    /*Fin: Cartografia Tematica*/

    /*Inicio: Union de Capas o Layers*/
    if (layerCurrentTitle === 'g_00_02:00_02_002_03_000_000_0000_00_00') {
        layers = [
            new ol.layer.Group({'title': 'Mapa Base', layers: layersMapaBase}),
            new ol.layer.Group({title: 'CARTOGRAFIA BASE', layers: layersCartografiaBase})
        ];
    } else {
        layers = [
            new ol.layer.Group({'title': 'Mapa Base', layers: layersMapaBase}),
            //overlayGroupPP,
            new ol.layer.Group({title: "Cartograf\xeda Tem\xe1tica", layers: current_wms}),
            new ol.layer.Group({title: 'CARTOGRAFIA BASE', layers: layersCartografiaBase})
        ];
    }
    /*Fin: Union de Capas o Layers*/

    /*Inicio: Mapa*/
    var map = new ol.Map({
        target: document.getElementById('map'),
        renderer: 'canvas',
        layers: layers,
        view: view,
        controls: controls,
        interactions: interactions,

        loadTilesWhileAnimating: true,
        loadTilesWhileInteracting: true,

        controls: ol.control.defaults({
            attribution: false,
            attributionOptions: ({
                collapsible: false
            })
        }).extend([
            new ol.control.FullScreen(),
            new ol.control.LayerSwitcher(),
            new ol.control.ZoomSlider(),
            new ol.control.CanvasScaleLine()
        ])
    });
    /*Fin: Mapa*/

    /*Inicio: Controles*/
    //...i
    var dragdrop = new ol.interaction.DragAndDrop({formatConstructors: [ol.format.GPX, ol.format.KML, ol.format.GeoJSON]});
    map.addInteraction(dragdrop);

    dragdrop.on("addfeatures", function (a) {
        a = new ol.source.Vector({features: a.features, projection: a.projection});
        map.getLayers().push(new ol.layer.Vector({source: a}));
        map.getView().fitExtent(a.getExtent(), map.getSize())
    });
    //...f

    //...i
    var zoom_to_extent = new ol.control.ZoomToExtent({
        extent: extent});
    map.addControl(zoom_to_extent);

    var sidebar = new ol.control.Sidebar({ element: 'sidebar_ol', position: 'right' });
    map.addControl(sidebar);
    //...f

    //...i
    var popup = new ol.Overlay.Popup();
    popup.setOffset([0, 0]);
    map.addOverlay(popup);


    // var wmsSource = new ol.source.TileWMS({
    //   url: 'https://ahocevar.com/geoserver/wms',
    //   params: {'LAYERS': 'ne:ne', 'TILED': true},
    //   serverType: 'geoserver',
    //   crossOrigin: 'anonymous',
    // });

    // var wmsLayer = new ol.layer.Image({
    //   source: wmsSource,
    // });

    var wmsSource = new ol.source.ImageWMS({
      url: 'http://localhost:8080/geoserver/senamhi_v1/wms',
      params: {"LAYERS": 'senamhi_v1:q_pp'},
      serverType: 'geoserver'
    });

    var wmsLayer = new ol.layer.Image({
      source: wmsSource,
    });

    
    

    

    // map.on('singleclick', function(evt) {
    //     // document.getElementById('nodelist').innerHTML = "Loading... please wait...";
    //     var view = map.getView();
    //     var viewResolution = view.getResolution();
    //     var source = wmsLayer.getSource();
    //     // var source = wmsSource.getSource();

    //     var url1 = source.getGetFeatureInfoUrl(
    //         evt.coordinate, viewResolution, view.getProjection(),
    //         {'INFO_FORMAT': 'text/html'});
    //     console.log(url1);
    //     // if (url1) {
    //     //     fetch(url1)
    //     //         .then(function (response) { return response.text(); })
    //     //         .then(function (html) {
    //     //         document.getElementById('info').innerHTML = html;
    //     //     });
    //     // }
    //     if (url1) {
    //         var parser = new ol.format.GeoJSON();
    //         $.ajax({
    //             url: url1,
    //             dataType: 'json',
    //             jsonpCallback: 'parseResponse'
    //         }).then(function(response) {
    //             console.log(response);
    //             var result = parser.readFeatures(response);
    //             console.log(result);
    //             if (result.length) {
    //                 var inf = [];
    //                 for (var i = 0, ii = result.length; i < ii; ++i) {
    //                     inf.push(result[i].get('nam'));
    //                 }
    //             document.getElementById('info').innerHTML = inf.join(', ');
    //             } else {
    //             document.getElementById('info').innerHTML = '&nbsp;';
    //           }
    //         });
    //     }
    // });


    ///////////////////////////////////////////////////////////////////////

    // map.on('singleclick', function (evt) {
    //   document.getElementById('info').innerHTML = '';
    //   var resolution = map.getView().getResolution();
    //   var url = wmsLayer.getSource().getGetFeatureInfoUrl(
    //     evt.coordinate,
    //     resolution,
    //     'EPSG:4326',
    //     {'INFO_FORMAT': 'application/json'}
    //   );
    //   console.log(url);
      // if (url) {
      //   fetch(url, {mode: 'no-cors'})
      //     .then(function (response) { console.log(response.text()); })
      //     .then(function (html) {
      //       document.getElementById('info').innerHTML = html;
      //     });
      // }
    //   if (url) {
    //       var parser = new ol.format.GeoJSON();
    //       var lookup = {};
    //       $.ajax({
    //           url: url,
    //           dataType: 'jsonp',
    //           method: 'GET',
    //           mode: 'no-cors',
    //           contentType: 'application/json',
    //           success: function (response) {
    //                           alert("hI");                                  
    //                       },
    //           error:  function(jqXHR, exception) {
    //                       if (jqXHR.status === 0) {
    //                           alert('Not connect.\n Verify Network.');
    //                       } else if (jqXHR.status == 404) {
    //                           alert('Requested page not found. [404]');
    //                       } else if (jqXHR.status == 500) {
    //                           alert('Internal Server Error [500].');
    //                       } else if (exception === 'parsererror') {
    //                           alert(exception);
    //                       } else if (exception === 'timeout') {
    //                           alert('Time out error.');
    //                       } else if (exception === 'abort') {
    //                           alert('Ajax request aborted.');
    //                       } else {
    //                           alert('Uncaught Error.\n' + jqXHR.responseText);
    //                       }
    //                   }
    //       });

    //   }
    // });

    map.on('singleclick', function(evt) {
        getInfo(evt, wmsLayer);
    });

    function getInfo(evt, layer) {
        var resolution = map.getView().getResolution();
        var coordinate = evt.coordinate;
        var pixel = evt.pixel;
        var thislayer = layer.getSource().getParams().LAYERS;
        
        console.log(resolution);
        console.log(coordinate);
        console.log(pixel);
        console.log(thislayer);

        var url = layer.getSource().getGetFeatureInfoUrl(evt.coordinate,
            resolution, 'EPSG:4326', {'INFO_FORMAT': 'application/json', 'FEATURE_COUNT': 50 });

        console.log(url);

        // if (url) {
        //     fetch(url, {method: 'GET', mode: 'no-cors'})
        //         // .then(function (response) { return response.text(); })
        //         .then(function (response) { R=>response.text()})
        //         .then(function (html) {
        //         document.getElementById('info').innerHTML = html;
        //     });
        // }
        if (url){
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log(data["features"][0]["properties"])
                });
        }

    };



    // map.on('pointermove', showInfo);

    // var info = document.getElementById('info');
    // function showInfo(event) {
    //   var features = map.getFeaturesAtPixel(event.pixel);
    //   if (features.length == 0) {
    //     info.innerText = '';
    //     info.style.opacity = 0;
    //     return;
    //   }
    //   var properties = features[0].getProperties();
    //   info.innerText = JSON.stringify(properties, null, 2);
    //   info.style.opacity = 1;
    // }


    //...f
    /*Fin: Controles*/

    /*Inicio: Show Mapa*/
    map.getView().fit(extent, map.getSize());
    /*Fin: Show Mapa*/

};


//...Funcion principal...
var MapOpenLayer = function (proyeccion, extent, presicionDecimal, wmsCurrent, layerCurrent, layerCurrentTitle, wmsMapaBase, keyBingMap, dominio) {
    return{
        init: function (proyeccion, extent, presicionDecimal, wmsCurrent, layerCurrent, layerCurrentTitle, wmsMapaBase, keyBingMap, dominio) {
            handleOpenLayerSetting(proyeccion, extent, presicionDecimal, wmsCurrent, layerCurrent, layerCurrentTitle, wmsMapaBase, keyBingMap, dominio);
        }
    };
}();

